{% extends "base.html" %}
{% block content %}

<!-- Import Font Premium -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">

<style>
  /* --- GLOBAL STYLES --- */
  :root {
    --font-head: 'Plus Jakarta Sans', sans-serif;
    --font-body: 'Inter', sans-serif;
    --color-dark: #0f172a;
    --color-muted: #64748b;
    --border-light: #e2e8f0;
    --bg-surface: #ffffff;
  }

  body {
    background-color: #f8fafc;
  }

  h1, h2, h3, h4, h5, h6 { font-family: var(--font-head); color: var(--color-dark); }
  p, td, th, span, div { font-family: var(--font-body); }

  /* --- CLEAN CARDS --- */
  .card-clean {
    background: var(--bg-surface);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03); /* Ultra soft shadow */
    transition: all 0.3s ease;
  }
  
  .card-clean:hover {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
    transform: translateY(-2px);
  }

  .card-header-clean {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-light);
    background: transparent;
    font-weight: 600;
    font-size: 1rem;
    color: var(--color-dark);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .card-body-clean { padding: 1.5rem; }

  /* --- IMAGE PREVIEW --- */
  .img-article {
    width: 100%;
    height: 240px;
    object-fit: cover;
    border-radius: 12px;
    border: 1px solid var(--border-light);
  }

  /* --- MODERN TABLE --- */
  .table-elegant {
    width: 100%;
    border-collapse: collapse;
  }
  .table-elegant thead th {
    background-color: #f8fafc;
    color: var(--color-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-light);
    font-weight: 600;
  }
  .table-elegant tbody td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
    font-size: 0.9rem;
    vertical-align: middle;
  }
  .table-elegant tr:last-child td { border-bottom: none; }
  .table-elegant tr:hover td { background-color: #f8fafc; }

  /* --- BADGES --- */
  .status-pill {
    padding: 4px 10px;
    border-radius: 99px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .pill-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
  .pill-warning { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
  .pill-secondary { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
  
  .dot { width: 6px; height: 6px; border-radius: 50%; background-color: currentColor; }

  /* --- BUTTONS --- */
  .btn-action {
    background: white;
    border: 1px solid var(--border-light);
    color: var(--color-dark);
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: 0.2s;
  }
  .btn-action:hover { background: #f8fafc; border-color: #cbd5e1; }

  /* =================== PRINT STYLES (SURAT RESMI) =================== */
  .print-only { display: none; }

  @media print {
    @page { size: A4; margin: 2cm; }
    body { background: white !important; color: black !important; font-family: 'Times New Roman', serif; }
    
    /* Hide Web Elements */
    .no-print, .sidebar, .top-header, .btn, canvas, .card-clean:hover { 
      display: none !important; 
    }
    
    /* Layout Reset */
    .col-lg-7, .col-lg-5, .col-12, .row { width: 100% !important; display: block !important; margin: 0 !important; }
    .card-clean { box-shadow: none !important; border: none !important; margin-bottom: 20px !important; }
    .card-header-clean { border-bottom: 2px solid black !important; padding-left: 0; }
    
    /* Show Print Elements */
    .print-only { display: block !important; }
    
    /* Table Print */
    .table-elegant th, .table-elegant td { border: 1px solid black !important; padding: 8px !important; font-size: 11pt; }
    .table-elegant thead th { background: #eee !important; color: black !important; }
    
    /* Image Print */
    .img-article { height: 150px; width: auto; float: left; margin-right: 20px; border: 1px solid #ccc; }
    
    /* Signature */
    .signature-box { display: flex; justify-content: space-between; margin-top: 50px; }
    .sign-col { width: 30%; text-align: center; }
    .sign-line { margin-top: 70px; border-bottom: 1px solid black; }
  }
</style>

<!-- KOP SURAT (PRINT ONLY) -->
<div class="print-only text-center mb-4">
  <h2 style="margin:0; text-transform:uppercase; letter-spacing:2px;">PT Glory Mitra Indo</h2>
  <p style="margin:0; font-size:10pt;">Jl. Industri Raya No. 88, Jakarta | Telp: (021) 555-8888</p>
  <hr style="border-top: 2px solid black; margin-top: 10px;">
  <h3 style="margin-top:20px; text-decoration:underline;">LAPORAN PRODUKSI</h3>
</div>

<!-- HEADER WEB -->
<div class="d-flex justify-content-between align-items-end mb-4 no-print">
  <div>
    <h6 class="text-uppercase text-muted small fw-bold mb-1" style="letter-spacing: 1px;">Modul Produksi</h6>
    <h2 class="fw-bold m-0 text-dark">Detail Artikel</h2>
  </div>
  <div class="d-flex gap-2">
    <a href="{{ url_for('produksi.index') }}" class="btn btn-light border text-secondary">
      <i class="bi bi-arrow-left me-1"></i> Kembali
    </a>
    <button class="btn btn-dark" onclick="window.print()">
      <i class="bi bi-printer me-1"></i> Cetak Laporan
    </button>
  </div>
</div>

<div class="row g-4">
  
  <!-- 1. INFO CARD (Kiri) -->
  <div class="col-lg-7">
    <div class="card-clean h-100">
      <div class="card-header-clean">
        <span><i class="bi bi-info-circle me-2 text-primary"></i>Informasi Produk</span>
        <span class="badge bg-light text-dark border">{{ article.tanggal_dibuat.strftime('%d %b %Y') }}</span>
      </div>
      <div class="card-body-clean">
        <div class="d-flex gap-4 align-items-start d-block-print">
          
          <!-- Gambar -->
          <div style="flex: 0 0 180px;">
            {% if article.gambar %}
              <img src="{{ url_for('static', filename='uploads/' + article.gambar) }}" 
                   class="img-article" alt="Artikel">
            {% else %}
              <div class="bg-light rounded d-flex align-items-center justify-content-center text-muted border" 
                   style="width:100%; height:200px; border-radius:12px;">
                <div class="text-center">
                  <i class="bi bi-image fs-3"></i><br><span class="small">No Image</span>
                </div>
              </div>
            {% endif %}
          </div>

          <!-- Detail Text -->
          <div class="flex-grow-1">
            <h4 class="fw-bold text-dark mb-1">{{ article.nama_artikel }}</h4>
            <p class="text-muted small mb-3">ID: #ART-{{ article.id }}</p>
            
            <div class="p-3 rounded bg-light border mb-3">
              <h6 class="text-uppercase small text-muted fw-bold mb-1" style="font-size:0.7rem;">Keterangan</h6>
              <p class="m-0 small text-dark" style="line-height:1.6;">
                {{ article.keterangan or 'Belum ada keterangan spesifik untuk artikel ini.' }}
              </p>
            </div>

            <!-- Print Timestamp -->
            <div class="print-only small mt-2">
              Dicetak pada: {{ now().strftime('%d %B %Y, %H:%M') }}
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- 2. CHART CARD (Kanan) -->
  <div class="col-lg-5 no-print">
    <div class="card-clean h-100">
      <div class="card-header-clean">
        <span><i class="bi bi-pie-chart me-2 text-primary"></i>Progress Pengerjaan</span>
      </div>
      <div class="card-body-clean d-flex flex-column align-items-center justify-content-center">
        <div style="position: relative; width: 200px; height: 200px;">
          <canvas id="progressChart"></canvas>
        </div>
        
        <!-- Legend Manual yang Bersih -->
        <div class="d-flex gap-3 mt-4 small text-muted">
          <div class="d-flex align-items-center gap-1">
            <span class="dot" style="background:#10b981"></span> Selesai
          </div>
          <div class="d-flex align-items-center gap-1">
            <span class="dot" style="background:#f59e0b"></span> Proses
          </div>
          <div class="d-flex align-items-center gap-1">
            <span class="dot" style="background:#e2e8f0"></span> Pending
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. TABEL CARD (Bawah) -->
  <div class="col-12">
    <div class="card-clean">
      <div class="card-header-clean">
        <span><i class="bi bi-list-check me-2 text-primary"></i>Rincian Tahapan</span>
      </div>
      <div class="p-0 table-responsive">
        <table class="table-elegant">
          <thead>
            <tr>
              <th class="ps-4">Tahap Produksi</th>
              <th>Status</th>
              <th>Tgl Update</th>
              <th>Catatan / Keterangan</th>
              <th>Biaya (Est)</th>
              <th class="text-center pe-4 no-print">Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% for s in article.steps %}
            <tr>
              <td class="ps-4 fw-bold">
                <!-- Logic Nama Tahap -->
                {% if s.tahap == 'Pembelian Bahan' %}Pemakaian Bahan{% else %}{{ s.tahap }}{% endif %}
              </td>
              
              <td>
                <!-- Status Badge -->
                <span class="no-print">
                  {% if s.status == 'selesai' %}
                    <span class="status-pill pill-success"><span class="dot"></span> Selesai</span>
                  {% elif s.status == 'proses' %}
                    <span class="status-pill pill-warning"><span class="dot"></span> Proses</span>
                  {% else %}
                    <span class="status-pill pill-secondary"><span class="dot"></span> Pending</span>
                  {% endif %}
                </span>
                <!-- Print Text -->
                <span class="print-only fw-bold text-uppercase" style="font-size:9pt;">{{ s.status }}</span>
              </td>

              <td class="text-muted small">{{ s.tanggal_update.strftime('%d/%m/%y') }}</td>
              
              <td class="small" style="max-width: 280px; line-height:1.4;">
                {{ s.keterangan or '-' }}
              </td>

              <td class="fw-bold font-monospace text-dark">
                {% if s.harga_cutting %}Rp {{ "{:,.0f}".format(s.harga_cutting) }}
                {% elif s.harga_jahit %}Rp {{ "{:,.0f}".format(s.harga_jahit) }}
                {% elif s.harga_total %}Rp {{ "{:,.0f}".format(s.harga_total) }}
                {% else %}<span class="text-muted">-</span>{% endif %}
              </td>

              <td class="text-center pe-4 no-print">
                <a href="{{ url_for('produksi.edit_step', step_id=s.id) }}" class="btn-action text-decoration-none">
                  Edit
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- SIGNATURE (PRINT ONLY) -->
<div class="print-only signature-box">
  <div class="sign-col">
    <p>Dibuat Oleh,</p>
    <div class="sign-line"></div>
    <p class="mt-1">Admin Produksi</p>
  </div>
  <div class="sign-col">
    <p>Diperiksa Oleh,</p>
    <div class="sign-line"></div>
    <p class="mt-1">Ka. Bagian Produksi</p>
  </div>
  <div class="sign-col">
    <p>Disetujui Oleh,</p>
    <div class="sign-line"></div>
    <p class="mt-1">Direktur Operasional</p>
  </div>
</div>

<!-- CHART SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const steps = {{ steps_data|tojson }};
    const total = steps.length;
    let selesai = 0, proses = 0, belum = 0;
    steps.forEach(s => {
      if (s.status === "selesai") selesai++;
      else if (s.status === "proses") proses++;
      else belum++;
    });
    const percent = total > 0 ? ((selesai / total) * 100).toFixed(0) : 0;

    const centerTextPlugin = {
      id: 'centerText',
      afterDraw(chart) {
        const { ctx, chartArea: { width, height } } = chart;
        ctx.save();
        ctx.font = 'bold 32px "Plus Jakarta Sans", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#0f172a';
        ctx.fillText(percent + '%', width / 2, height / 2 + 5);
        ctx.font = '12px "Inter", sans-serif';
        ctx.fillStyle = '#64748b';
        ctx.fillText('Selesai', width / 2, height / 2 + 24);
      }
    };

    new Chart(document.getElementById("progressChart"), {
      type: 'doughnut',
      data: {
        labels: ['Selesai', 'Proses', 'Pending'],
        datasets: [{
          data: [selesai, proses, belum],
          backgroundColor: ['#10b981', '#f59e0b', '#e2e8f0'],
          borderWidth: 0, hoverOffset: 8
        }]
      },
      options: { cutout: '78%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } },
      plugins: [centerTextPlugin]
    });
  });
</script>

{% endblock %}